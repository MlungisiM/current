name: $(Date:yyyyMMdd)$(Rev:.r)
trigger:
  branches:
    include:
    - main
schedules:
- cron: "0 6 * * *"
  displayName: Daily test run
  branches:
    include:
    - main
  always: true
variables:
- name: JAVA_HOME
  value: /usr/lib/jvm/java-21-openjdk
- name: MAVEN_OPTS
  value: -Dfile.encoding=UTF-8
- name: EXTENT_REPORT
  value: "target/reports/automation-report.html"
- name: SCREENSHOTS_DIR
  value: "target/reports/screenshots"
- name: TESTNG_RESULTS
  value: "target/testng-output"
stages:
- stage: __default
  jobs:
  - job: Job
    pool:
      vmImage: 'ubuntu-latest'
    steps:
    - task: JavaToolInstaller@0
      inputs:
        versionSpec: '21'
        jdkArchitectureOption: 'x64'
        jdkSourceOption: 'PreInstalled'
    - task: CmdLine@2
      displayName: 'Configure Secure Maven'
      inputs:
        script: |
          mkdir -p ~/.m2
          cat > ~/.m2/settings.xml << 'EOF'
          <settings>
            <mirrors>
              <mirror>
                <id>secure-central</id>
                <name>Maven Central</name>
                <url>https://repo.maven.apache.org/maven2</url>
                <mirrorOf>central</mirrorOf>
              </mirror>
            </mirrors>
          </settings>
          EOF
    - task: CmdLine@2
      displayName: 'Prepare TestNG directory'
      inputs:
        script: |
          mkdir -p $(TESTNG_RESULTS)
    - task: CmdLine@2
      inputs:
        script: |
          mvn clean test \
          -Dtestng.output.dir=$(TESTNG_RESULTS) \
          -Dfile.encoding=UTF-8 \
          -Dsurefire.reportsDirectory=$(System.DefaultWorkingDirectory)/target/surefire-reports
      displayName: 'Run TestNG Tests'
    - task: CmdLine@2
      displayName: 'Collect Test Artifacts'
      inputs:
        script: |
          mkdir -p $(Build.ArtifactStagingDirectory)/artifacts/{reports,screenshots}

          # Copy Extent Report
          if [ -f "$(EXTENT_REPORT)" ]; then
            cp "$(EXTENT_REPORT)" $(Build.ArtifactStagingDirectory)/artifacts/reports/
            echo "##[section]Extent Report copied successfully"
          fi

          # Copy screenshots
          if [ -d "$(SCREENSHOTS_DIR)" ]; then
            cp -r "$(SCREENSHOTS_DIR)" $(Build.ArtifactStagingDirectory)/artifacts/screenshots/
          fi

          # Copy TestNG reports
          if [ -d "$(TESTNG_RESULTS)" ]; then
            cp -r "$(TESTNG_RESULTS)" $(Build.ArtifactStagingDirectory)/artifacts/reports/testng/
          fi

          # Copy surefire reports
          if [ -d "target/surefire-reports" ]; then
            cp -r target/surefire-reports $(Build.ArtifactStagingDirectory)/artifacts/reports/surefire/
          fi
    - task: PublishTestResults@2
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/testng-results.xml, **/TEST-*.xml'
        searchFolder: '$(System.DefaultWorkingDirectory)'
        mergeTestResults: true
        testRunTitle: 'TestNG Results'
    - task: PublishBuildArtifacts@1
      inputs:
        PathtoPublish: '$(Build.ArtifactStagingDirectory)/artifacts'
        ArtifactName: 'Test_Artifacts'
        publishLocation: 'Container'

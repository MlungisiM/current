name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main

schedules:
  - cron: "0 6 * * *"  # 8am SAST is 6am UTC
    displayName: Daily test run
    branches:
      include:
        - main
    always: true

variables:
  JAVA_HOME: /usr/lib/jvm/java-21-openjdk
  MAVEN_OPTS: -Dfile.encoding=UTF-8
  EXTENT_REPORT: "target/reports/automation-report.html"
  SCREENSHOTS_DIR: "target/reports/screenshots"
  TESTNG_RESULTS: "target/testng-output"
  # Full URL for Selenium framework, forcing HTTPS
  external_dev_environment_url: "https://www.devcregalink.co.za/cregaweb/faces/index.xhtml"

pool:
  vmImage: 'ubuntu-latest'

steps:

  # Install Java
  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '21'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'

  # Configure Maven
  - script: |
      mkdir -p ~/.m2
      cat > ~/.m2/settings.xml << 'EOF'
      <settings>
        <mirrors>
          <mirror>
            <id>secure-central</id>
            <name>Maven Central</name>
            <url>https://repo.maven.apache.org/maven2</url>
            <mirrorOf>central</mirrorOf>
          </mirror>
        </mirrors>
      </settings>
      EOF
    displayName: 'Configure Secure Maven'

  # Prepare TestNG directory
  - script: |
      mkdir -p $(TESTNG_RESULTS)
    displayName: 'Prepare TestNG directory'

  # Run Selenium/TestNG tests
  - task: CmdLine@2
    inputs:
      script: |
        mvn clean test \
        -Dtestng.output.dir=$(TESTNG_RESULTS) \
        -Dfile.encoding=UTF-8 \
        -Dsurefire.reportsDirectory=$(System.DefaultWorkingDirectory)/target/surefire-reports \
        -DbaseUrl=$(external_dev_environment_url)
    displayName: 'Run TestNG Tests'

  # Collect artifacts (reports, screenshots)
  - script: |
      mkdir -p $(Build.ArtifactStagingDirectory)/artifacts/{reports,screenshots}
      
      # Copy Extent Report
      if [ -f "$(EXTENT_REPORT)" ]; then
        cp "$(EXTENT_REPORT)" $(Build.ArtifactStagingDirectory)/artifacts/reports/

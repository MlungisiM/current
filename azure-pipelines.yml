trigger:
  branches:
    include:
      - "*"  # Runs on every branch commit

schedules:
  - cron: "0 6 * * *"  # 8 AM SAST = 6 AM UTC
    displayName: Daily Build at 8AM SAST
    branches:
      include:
        - main
    always: true  # Run even if no changes

pool:
  vmImage: 'ubuntu-latest'

variables:
  mavenOpts: '-Xmx1024m'

steps:

# Step 1: Use Java 21
- task: JavaToolInstaller@0
  inputs:
    versionSpec: '21'
    jdkArchitecture: 'x64'
    jdkSourceOption: 'PreInstalled'
  displayName: 'Set up Java 21'


# Step 2: Clean Project
- task: Maven@4
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean'
    options: '-B'
  displayName: 'Maven Clean'

# Step 3: Fix Permissions (if needed)
- script: |
    sudo chmod -R 777 $(System.DefaultWorkingDirectory)/target || true
  displayName: 'Fix target directory permissions'

# Step 4: Run Tests
- task: Maven@4
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'test'
    options: '-B'
  displayName: 'Run Tests'

# Step 5: Publish Test Results
- task: PublishTestResults@2
  inputs:
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    testResultsFormat: 'JUnit'
    failTaskOnFailedTests: true
  condition: succeededOrFailed()
  displayName: 'Publish JUnit Test Results'

# Step 6: Publish HTML Report (e.g., ExtentReports)
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports'
    ArtifactName: 'TestReports'
    publishLocation: 'Container'
  condition: always()
  displayName: 'Publish Extent Report'

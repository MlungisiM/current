name: $(Date:yyyyMMdd)$(Rev:.r)

trigger:
  branches:
    include:
      - main

schedules:
  - cron: "0 6 * * *"  # 8am SAST is 6am UTC
    displayName: Daily test run
    branches:
      include:
        - main
    always: true

variables:
  JAVA_HOME: /usr/lib/jvm/java-21-openjdk
  MAVEN_OPTS: -Dfile.encoding=UTF-8
  EXTENT_REPORT: "target/reports/automation-report.html"
  SCREENSHOTS_DIR: "target/reports/screenshots"
  TESTNG_RESULTS: "target/testng-output"
  external_dev_environment_url: "https://www.devcregalink.co.za/cregaweb/faces/index.xhtml"

pool:
  vmImage: 'ubuntu-latest'

steps:

- script: |
    echo "ðŸ” Checking reachability of test environment..."
    echo "Target URL: $(external_dev_environment_url)"

    # Extract hostname from full URL (www.devcregalink.co.za)
    HOSTNAME=$(echo $(external_dev_environment_url) | awk -F/ '{print $3}')
    echo "Checking DNS resolution for $HOSTNAME"

    if nslookup $HOSTNAME; then
      echo "âœ… DNS resolved for $HOSTNAME"
    else
      echo "âŒ DNS resolution failed for $HOSTNAME"
      exit 1
    fi

    echo "ðŸŒ Checking HTTP reachability for full URL: $(external_dev_environment_url)"
    if curl -vk --max-time 20 --fail $(external_dev_environment_url); then
      echo "âœ… Environment is reachable"
    else
      echo "âŒ Test environment not reachable at $(external_dev_environment_url). Aborting tests."
      exit 1
    fi
  displayName: "Test environment reachability"

- task: JavaToolInstaller@0
  inputs:
    versionSpec: '21'
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'

- script: |
    mkdir -p ~/.m2
    cat > ~/.m2/settings.xml << 'EOF'
    <settings>
      <mirrors>
        <mirror>
          <id>secure-central</id>
          <name>Maven Central</name>
          <url>https://repo.maven.apache.org/maven2</url>
          <mirrorOf>central</mirrorOf>
        </mirror>
      </mirrors>
    </settings>
    EOF
  displayName: 'Configure Secure Maven'

- script: |
    mkdir -p $(TESTNG_RESULTS)
  displayName: 'Prepare TestNG directory'

- task: CmdLine@2
  inputs:
    script: |
      mvn clean test \
      -Dtestng.output.dir=$(TESTNG_RESULTS) \
      -Dfile.encoding=UTF-8 \
      -Dsurefire.reportsDirectory=$(System.DefaultWorkingDirectory)/target/surefire-reports \
      -DbaseUrl=$(external_dev_environment_url)
  displayName: 'Run TestNG Tests'

- script: |
    mkdir -p $(Build.ArtifactStagingDirectory)/artifacts/{reports,screenshots}
    
    # Copy Extent Report
    if [ -f "$(EXTENT_REPORT)" ]; then
      cp "$(EXTENT_REPORT)" $(Build.ArtifactStagingDirectory)/artifacts/reports/
      echo "##[section]Extent Report copied successfully"
    fi
    
    # Copy screenshots
    if [ -d "$(SCREENSHOTS_DIR)" ]; then
      cp -r "$(SCREENSHOTS_DIR)" $(Build.ArtifactStagingDirectory)/artifacts/screenshots/
    fi
    
    # Copy TestNG reports
    if [ -d "$(TESTNG_RESULTS)" ]; then
      cp -r "$(TESTNG_RESULTS)" $(Build.ArtifactStagingDirectory)/artifacts/reports/testng/
    fi
    
    # Copy surefire reports
    if [ -d "target/surefire-reports" ]; then
      cp -r target/surefire-reports $(Build.ArtifactStagingDirectory)/artifacts/reports/surefire/
    fi
  displayName: 'Collect Test Artifacts'

- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'JUnit'
    testResultsFiles: '**/testng-results.xml, **/TEST-*.xml'
    searchFolder: '$(System.DefaultWorkingDirectory)'
    mergeTestResults: true
    testRunTitle: 'TestNG Results'

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)/artifacts'
    ArtifactName: 'Test_Artifacts'
    publishLocation: 'Container'

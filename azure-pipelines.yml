trigger:
  branches:
    include:
      - "*"  # Runs on every branch commit

schedules:
  - cron: "0 6 * * *"  # 8 AM SAST = 6 AM UTC
    displayName: Daily Build at 8AM SAST
    branches:
      include:
        - main
    always: true  # Run even if no changes

pool:
  vmImage: 'ubuntu-latest'

variables:
  mavenOpts: '-Xmx1024m'

steps:

# Step 1: Use Java 21
- task: JavaToolInstaller@0
  inputs:
    versionSpec: '21'
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'
  displayName: 'Set up Java 21'

- script: java -version
  displayName: 'Check Java Version'

# Step 2: Clean Project
- task: Maven@4
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean'
    options: '-B'
  displayName: 'Maven Clean'

# Step 3: Fix Permissions (if needed)
- script: |
    sudo chmod -R 777 $(System.DefaultWorkingDirectory)/target || true
  displayName: 'Fix target directory permissions'

# Step 4: Run Tests using testng.xml
- task: Maven@4
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'test'
    options: '-B -DsuiteXmlFile=testng.xml'
  displayName: 'Run Tests using testng.xml'


# Step 5: Publish HTML Report (e.g., ExtentReports)
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(System.DefaultWorkingDirectory)/reports'
    ArtifactName: 'automation-report.html'
    publishLocation: 'Container'
  displayName: 'Publish Extent Report'

  # Step 6: Prevent pipeline from failing if report is missing
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(System.DefaultWorkingDirectory)/reports'
    ArtifactName: 'automation-report.html'
    publishLocation: 'Container'
  displayName: 'Publish Extent Report'
  continueOnError: true


  

